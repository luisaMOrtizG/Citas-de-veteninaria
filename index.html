<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Veterinaria</title>
    <head>
<link rel="stylesheet" href="veterinaria.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    
</head>
<body>
    <div class="container my-4">
        <h2 class="text-center">Veterinaria</h2>
        <div class="d-flex justify-content-between align-items-center my-3">
            <div>
                <label for="filtroEstado">Filtrar por estado</label>
                <select id="filtroEstado" class="form-select">
                    <option value="">-- Todos --</option>
                    <option value="Abierta">Abierta</option>
                    <option value="Terminada">Terminada</option>
                    <option value="Anulada">Anulada</option>
                </select>
            </div>
            <button class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#citaModal">
                AGREGAR CITA
            </button>
        </div>
        <input type="text" id="busqueda" class="form-control mb-3"
            placeholder="Buscar por nombre de mascota o propietario..." />
        <div class="green-bar"></div>
        <div id="listaCitas" class="row gy-3"></div>
    </div>
    
    <!-- Modal para agregar cita -->
    <div class="modal fade" id="citaModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Guardar nueva cita</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formCita" novalidate>
                        <input type="text" class="form-control mb-2" id="mascota" placeholder="Nombre Mascota" />
                        <input type="text" class="form-control mb-2" id="propietario" placeholder="Propietario" />
                        <input type="tel" class="form-control mb-2" id="telefono" placeholder="Teléfono" />
                        <div class="row mb-2">
                            <div class="col">
                                <label>Fecha</label>
                                <input type="date" class="form-control" id="fecha" min="" />
                            </div>
                            <div class="col">
                                <label>Hora</label>
                                <input type="time" class="form-control" id="hora" min="08:00" max="20:00" />
                            </div>
                        </div>
                        <label for="tipoMascota" class="form-label mt-3">Tipo de mascota</label>
                        <select class="form-select" id="tipoMascota">
                            <option value="">-- Selecciona --</option>
                            <option value="Perro">Perro</option>
                            <option value="Gato">Gato</option>
                            <option value="Ave">Ave</option>
                            <option value="Pez">Pez</option>
                            <option value="Conejo">Conejo</option>
                            <option value="Hamster">Hámster</option>
                            <option value="Tortuga">Tortuga</option>
                            <option value="Serpiente">Serpiente</option>
                            <option value="Caballo">Caballo</option>
                            <option value="Cerdo">Cerdo</option>
                        </select>
                        <div class="text-center mt-2">
                            <img id="previewIcono" src="https://cdn-icons-png.flaticon.com/512/616/616408.png"
                                alt="Icono mascota" style="height: 60px" />
                        </div>
                        <label for="estado" class="form-label">Estado</label>
                        <select class="form-select mb-2" id="estado">
                            <option value="Abierta">Abierta</option>
                            <option value="Terminada">Terminada</option>
                            <option value="Anulada">Anulada</option>
                        </select>
                        <textarea class="form-control" id="sintomas" rows="3"
                            placeholder="Síntomas... (máx 400 caracteres)" maxlength="400"></textarea>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-danger" data-bs-dismiss="modal">
                        CERRAR
                    </button>
                    <button type="button" class="btn btn-success" id="btnGuardar">
                        GUARDAR
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal para confirmar eliminación -->
    <div class="modal fade" id="confirmarEliminarModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirmar eliminación</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="confirmarEliminarMensaje">¿Seguro que quieres eliminar esta cita?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="btnConfirmarEliminar">Eliminar</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal para confirmar eliminación de todas las citas -->
    <div class="modal fade" id="confirmarEliminarTodasModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirmar eliminación</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>¿Estás segura de que deseas eliminar todas las citas?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="btnConfirmarEliminarTodas">Eliminar todas</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Boton para eliminar todas las citas -->
    <div class="text-center my-4">
        <button class="btn btn-danger" onclick="eliminarTodasLasCitas()">
            Eliminar todas las citas
        </button>
    </div>
    
    <script>
        // Función para mostrar alerta personalizada
        function showCustomAlert(message) {
            // Crear elementos
            const backdrop = document.createElement('div');
            backdrop.className = 'custom-alert-backdrop';
            
            const alertDiv = document.createElement('div');
            alertDiv.className = 'custom-alert';
            alertDiv.innerHTML = `
                <h5>Oops...</h5>
                <p>${message}</p>
                <button class="btn-ok">OK</button>
            `;
            
            // Agregar al body
            document.body.appendChild(backdrop);
            document.body.appendChild(alertDiv);
            
            // Manejar clic en OK
            const btnOk = alertDiv.querySelector('.btn-ok');
            btnOk.addEventListener('click', () => {
                document.body.removeChild(backdrop);
                document.body.removeChild(alertDiv);
            });
        }

        // Configurar fecha mínima (mañana)
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            // Formatear a YYYY-MM-DD
            const minDate = tomorrow.toISOString().split('T')[0];
            document.getElementById('fecha').min = minDate;
        });

        const form = document.getElementById("formCita");
        const listaCitas = document.getElementById("listaCitas");
        const btnGuardar = document.getElementById("btnGuardar");
        const imagenesMascotas = { 
            Perro: "https://static.vecteezy.com/system/resources/previews/008/208/783/non_2x/golden-retriever-dog-cartoon-clipart-illustration-free-vector.jpg",
            Gato: "https://static.vecteezy.com/system/resources/previews/017/319/952/non_2x/cartoon-orange-cat-on-white-background-vector.jpg",
            Ave: "https://static.vecteezy.com/system/resources/thumbnails/002/197/761/small/realistic-colorful-bird-isolated-on-white-free-vector.jpg",   
            Pez: "https://static.vecteezy.com/system/resources/previews/007/987/463/non_2x/fish-in-cartoon-style-fish-icon-for-your-design-illustration-vector.jpg",     
            Conejo: "https://static.vecteezy.com/system/resources/thumbnails/005/162/468/small_2x/cartoon-funny-rabbit-in-the-grass-free-vector.jpg",
            Hamster: "https://static.vecteezy.com/system/resources/thumbnails/051/438/860/small/hamster-cartoon-illustration-illustration-vector.jpg",
            Tortuga: "https://static.vecteezy.com/system/resources/previews/009/359/981/non_2x/sea-turtle-cartoon-colored-clipart-illustration-free-vector.jpg",
            Serpiente: "https://static.vecteezy.com/system/resources/previews/039/398/971/non_2x/snake-cartoon-illustration-isolated-on-white-background-vector.jpg",
            Caballo: "https://static.vecteezy.com/system/resources/previews/006/045/884/non_2x/horse-illustration-with-colorful-free-vector.jpg",
            Cerdo: "https://static.vecteezy.com/system/resources/previews/009/693/377/non_2x/cartoon-happy-pig-vector.jpg"
        };

        let citas = JSON.parse(localStorage.getItem("citas")) || [];
        let citaEditando = null;
        let citaAEliminar = null;
        renderCitas();

        // Función para validar si un campo tiene contenido válido
        function validarCampo(campo, nombreCampo) {
            const valor = campo.value.trim();
            if (!valor) {
                showCustomAlert(`El campo ${nombreCampo} no puede estar vacío`);
                campo.classList.add("is-invalid");
                return false;
            }
            campo.classList.remove("is-invalid");
            return true;
        }

        // Función para validar el horario (8am a 8pm)
        function validarHorario(hora) {
            const [horas, minutos] = hora.split(':').map(Number);
            if (horas < 8 || horas >= 20) {
                showCustomAlert("El horario debe ser entre 8:00 AM y 8:00 PM");
                return false;
            }
            return true;
        }

        // Función para validar todos los campos requeridos
        function validarFormulario() {
            let valido = true;
            
            if (!validarCampo(document.getElementById("mascota"), "Nombre Mascota")) valido = false;
            if (!validarCampo(document.getElementById("propietario"), "Propietario")) valido = false;
            if (!validarCampo(document.getElementById("telefono"), "Teléfono")) valido = false;
            
            const fecha = document.getElementById("fecha");
            if (!validarCampo(fecha, "Fecha")) valido = false;
            
            const hora = document.getElementById("hora");
            if (!validarCampo(hora, "Hora")) valido = false;
            else if (!validarHorario(hora.value)) valido = false;
            
            if (!validarCampo(document.getElementById("tipoMascota"), "Tipo de mascota")) valido = false;
            if (!validarCampo(document.getElementById("sintomas"), "Síntomas")) valido = false;
            
            return valido;
        }

        // Cambiar imagen automáticamente al seleccionar tipo de mascota
        document.getElementById("tipoMascota").addEventListener("change", function () {
            const tipo = this.value;
            const preview = document.getElementById("previewIcono");
            
            if (imagenesMascotas[tipo]) {
                preview.src = imagenesMascotas[tipo];
            } else {
                preview.src = "https://cdn-icons-png.flaticon.com/512/616/616408.png";
            }
        });

        // Validar campos en tiempo real
        document.querySelectorAll("#formCita input, #formCita select, #formCita textarea").forEach(campo => {
            campo.addEventListener("input", function() {
                if (this.value.trim()) {
                    this.classList.remove("is-invalid");
                }
            });
        });

        // Manejar el clic en el botón Guardar
        btnGuardar.addEventListener("click", (e) => {
            e.preventDefault();
            
            // Validar el formulario antes de continuar
            if (!validarFormulario()) {
                return;
            }

            const tipo = document.getElementById("tipoMascota").value;
            const imagen = imagenesMascotas[tipo] || "https://cdn-icons-png.flaticon.com/512/616/616408.png";

            if (citaEditando) {
                // Actualizar cita existente
                const index = citas.findIndex(c => c.id === citaEditando);
                if (index !== -1) {
                    citas[index] = {
                        id: citaEditando,
                        mascota: document.getElementById("mascota").value.trim(),
                        propietario: document.getElementById("propietario").value.trim(),
                        telefono: document.getElementById("telefono").value.trim(),
                        fecha: document.getElementById("fecha").value,
                        hora: document.getElementById("hora").value,
                        estado: document.getElementById("estado").value,
                        sintomas: document.getElementById("sintomas").value.trim(),
                        tipoMascota: tipo,
                        imagen: imagen,
                    };
                }
                citaEditando = null;
            } else {
                // Crear nueva cita
                const cita = {
                    id: Date.now(),
                    mascota: document.getElementById("mascota").value.trim(),
                    propietario: document.getElementById("propietario").value.trim(),
                    telefono: document.getElementById("telefono").value.trim(),
                    fecha: document.getElementById("fecha").value,
                    hora: document.getElementById("hora").value,
                    estado: document.getElementById("estado").value,
                    sintomas: document.getElementById("sintomas").value.trim(),
                    tipoMascota: tipo,
                    imagen: imagen,
                };
                citas.push(cita);
            }
            
            localStorage.setItem("citas", JSON.stringify(citas));
            form.reset();
            
            // Restablecer fecha mínima
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            const minDate = tomorrow.toISOString().split('T')[0];
            document.getElementById('fecha').min = minDate;
            
            bootstrap.Modal.getInstance(document.getElementById("citaModal")).hide();
            renderCitas();
        });

        function renderCitas() {
            const filtroEstado = document.getElementById("filtroEstado").value.toLowerCase();
            const terminoBusqueda = document.getElementById("busqueda").value.toLowerCase();
            listaCitas.innerHTML = "";
            citas
                .filter(cita => {
                    const coincideEstado = filtroEstado ? cita.estado.toLowerCase() === filtroEstado : true;
                    const coincideBusqueda =
                        cita.mascota.toLowerCase().includes(terminoBusqueda) ||
                        cita.propietario.toLowerCase().includes(terminoBusqueda);
                    return coincideEstado && coincideBusqueda;
                })
                .forEach((cita) => {
                    const div = document.createElement("div");
                    div.className = "col-md-4";
                    div.innerHTML = `
                        <div class="card shadow p-3">
                            <img src="${cita.imagen}" class="img-fluid rounded mb-2" style="height: 100px; object-fit: contain;" alt="${cita.tipoMascota}">
                            <h5 class="text-center text-capitalize">${cita.mascota}</h5>
                            <p><strong>Tipo:</strong> ${cita.tipoMascota}</p>
                            <p><strong>Propietario:</strong> ${cita.propietario}</p>
                            <p><strong>Teléfono:</strong> ${cita.telefono}</p>
                            <p><strong>Fecha:</strong> ${cita.fecha} <strong>Hora:</strong> ${cita.hora}</p>
                            <p><strong>Síntomas:</strong> ${cita.sintomas}</p>
                            <select class="form-select mb-2" onchange="cambiarEstado(${cita.id}, this.value)">
                                <option ${cita.estado === "Abierta" ? "selected" : ""}>Abierta</option>
                                <option ${cita.estado === "Terminada" ? "selected" : ""}>Terminada</option>
                                <option ${cita.estado === "Anulada" ? "selected" : ""}>Anulada</option>
                            </select>
                            <div class="d-flex gap-2">
                                <button class="btn btn-outline-primary btn-sm" onclick="editarCita(${cita.id})">Editar</button>
                                <button class="btn btn-outline-danger btn-sm" onclick="eliminarCita(${cita.id})">Eliminar</button>
                            </div>
                        </div>
                    `;
                    listaCitas.appendChild(div);
                });
        }

        function editarCita(id) {
            const cita = citas.find(c => c.id === id);
            if (cita) {
                citaEditando = id;
                
                // Llenar el formulario con los datos de la cita
                document.getElementById("mascota").value = cita.mascota;
                document.getElementById("propietario").value = cita.propietario;
                document.getElementById("telefono").value = cita.telefono;
                document.getElementById("fecha").value = cita.fecha;
                document.getElementById("hora").value = cita.hora;
                document.getElementById("estado").value = cita.estado;
                document.getElementById("sintomas").value = cita.sintomas;
                document.getElementById("tipoMascota").value = cita.tipoMascota;
                
                // Actualizar la imagen preview
                const preview = document.getElementById("previewIcono");
                preview.src = cita.imagen;
                
                // Cambiar el título del modal
                document.getElementById("modalTitle").textContent = "Editar cita";
                document.getElementById("btnGuardar").textContent = "ACTUALIZAR";
                
                // Mostrar el modal
                const modal = new bootstrap.Modal(document.getElementById("citaModal"));
                modal.show();
            }
        }

        function cambiarEstado(id, nuevoEstado) {
            const cita = citas.find(c => c.id === id);
            if (cita) {
                cita.estado = nuevoEstado;
                localStorage.setItem("citas", JSON.stringify(citas));
                renderCitas();
            }
        }

        function eliminarCita(id) {
            citaAEliminar = id;
            const cita = citas.find(c => c.id === id);
            const mensaje = `¿Seguro que quieres eliminar la cita de ${cita.mascota} (${cita.propietario})?`;
            document.getElementById('confirmarEliminarMensaje').textContent = mensaje;
            
            const modal = new bootstrap.Modal(document.getElementById('confirmarEliminarModal'));
            modal.show();
        }

        function eliminarTodasLasCitas() {
            const modal = new bootstrap.Modal(document.getElementById('confirmarEliminarTodasModal'));
            modal.show();
        }

        // Configurar eventos para los botones de confirmación
        document.getElementById('btnConfirmarEliminar').addEventListener('click', () => {
            if (citaAEliminar) {
                citas = citas.filter(cita => cita.id !== citaAEliminar);
                localStorage.setItem("citas", JSON.stringify(citas));
                renderCitas();
                citaAEliminar = null;
            }
            bootstrap.Modal.getInstance(document.getElementById('confirmarEliminarModal')).hide();
        });

        document.getElementById('btnConfirmarEliminarTodas').addEventListener('click', () => {
            citas = [];
            localStorage.removeItem("citas");
            renderCitas();
            bootstrap.Modal.getInstance(document.getElementById('confirmarEliminarTodasModal')).hide();
        });

        // Filtrar por estado
        document.getElementById("filtroEstado").addEventListener("change", () => {
            renderCitas();
        });
        
        // Búsqueda por nombre o propietario
        document.getElementById("busqueda").addEventListener("input", () => {
            renderCitas();
        });

        // Resetear formulario al cerrar modal
        document.getElementById("citaModal").addEventListener("hidden.bs.modal", () => {
            form.reset();
            citaEditando = null;
            document.getElementById("modalTitle").textContent = "Guardar nueva cita";
            document.getElementById("btnGuardar").textContent = "GUARDAR";
            document.getElementById("previewIcono").src = "https://cdn-icons-png.flaticon.com/512/616/616408.png";
            
            // Limpiar clases de validación
            document.querySelectorAll(".is-invalid").forEach(campo => {
                campo.classList.remove("is-invalid");
            });
            
            // Restablecer fecha mínima
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            const minDate = tomorrow.toISOString().split('T')[0];
            document.getElementById('fecha').min = minDate;
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
